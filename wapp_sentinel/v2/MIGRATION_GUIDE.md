# Migration Guide: accepted_by → client_name

## Изменения:

### 1. База данных
- Колонка `orders.accepted_by` переименована в `orders.client_name`
- Создана миграция Alembic

### 2. Модели
- `Order.accepted_by` → `Order.client_name`

### 3. OpenAI Service
- Промпт обновлен: "Сотрудник" → "Имя клиента"
- Добавлена автоматическая подстановка текущего года
- Если год не указан в дате, LLM использует текущий год

### 4. Daily Report Service
- Улучшен дизайн отчета с рамками-разделителями
- Каждый заказ в отдельной рамке для лучшей читаемости
- Заголовки и статистика с двойными линиями (═)

## Применение миграции:

### Шаг 1: Остановите workers
```bash
# Нажмите Ctrl+C в терминалах с workers
```

### Шаг 2: Примените миграцию базы данных
```bash
cd /home/beybars/dev_python/napoleon_tseh/wapp_sentinel/v2
alembic upgrade head
```

### Шаг 3: Перезапустите все сервисы
```bash
# Терминал 1: FastAPI
python app/main.py

# Терминал 2: RabbitMQ Worker
python app/rabbitmq_worker.py

# Терминал 3: Order Processor Worker
python app/order_processor_worker.py
```

## Новый дизайн отчета:

```
════════════════════════════════════════
📋 ЗАКАЗЫ НА 04.11.2025
Всего заказов: 2
════════════════════════════════════════

┌──────────────────────────────────────┐
│ 1️⃣ ЗАКАЗ #15                          │
│ 🕐 Время доставки: 12:00              │
│ 💳 ✅ Оплачено                         │
│ 👤 Клиент: Айнур                      │
│ 📱 Контакт: +77001234567              │
│ 📦 Товары:                            │
│    • Торт "Наполеон" - 1 кг           │
│    • Капкейки - 6 шт                  │
│ 📅 Принят: 03.11.2025 18:30           │
└──────────────────────────────────────┘

┌──────────────────────────────────────┐
│ 2️⃣ ЗАКАЗ #16                          │
│ 🕐 Время доставки: 14:00              │
│ 💳 ❌ Не оплачено                      │
│ 👤 Клиент: Мария                      │
│ 📱 Контакт: +77009876543              │
│ 📦 Товары:                            │
│    • Торт "Прага" - 2 кг              │
│ 📅 Принят: 04.11.2025 09:00           │
└──────────────────────────────────────┘

════════════════════════════════════════
📊 СТАТИСТИКА:
   • Всего заказов: 2
   • Оплачено: 1
   • Не оплачено: 1
════════════════════════════════════════
```

## Преимущества нового дизайна:

✅ **Четкое разделение** - каждый заказ в отдельной рамке  
✅ **Визуально понятно** - легко отличить один заказ от другого  
✅ **Профессионально** - выглядит структурированно  
✅ **Читаемо** - даже при большом количестве заказов  

## Изменения в AI промпте:

### Было:
```
5. Сотрудник (accepted_by):
   - Обычно имя в конце сообщения
   - Примеры: "Айнур", "Мария", "Асель", "Айгерим"
```

### Стало:
```
5. Имя клиента (client_name):
   - Обычно имя клиента в сообщении
   - Примеры: "Айнур", "Мария", "Асель", "Айгерим", "Иван Петров"
   - Может быть в любом месте сообщения, но часто в конце
```

### Обработка года:
```
ВАЖНО: Текущий год - {current_year}. Используйте его для всех дат.

- "04.11 в 12:00" → используйте текущий год {current_year}
- Если год НЕ указан явно, используйте текущий год {current_year}
```

## Тестирование:

```bash
# Проверьте новый дизайн отчета
curl http://localhost:8000/orders/daily-report/2025-11-04
```

Теперь отчеты будут намного более читаемыми! 🎉

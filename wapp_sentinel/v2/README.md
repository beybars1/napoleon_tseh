# Napoleon Tseh - WhatsApp Sentinel v2

**ะะฒัะพะผะฐัะธะทะธัะพะฒะฐะฝะฝะฐั ัะธััะตะผะฐ ะพะฑัะฐะฑะพัะบะธ ะทะฐะบะฐะทะพะฒ ัะตัะตะท WhatsApp ั AI-ะฐะณะตะฝัะฐะผะธ ะธ ะฐะฝะฐะปะธัะธะบะพะน**

## ๐ฏ ะะฟะธัะฐะฝะธะต ะฟัะพะตะบัะฐ

Napoleon Tseh WhatsApp Sentinel - ััะพ ะบะพะผะฟะปะตะบัะฝะฐั ัะธััะตะผะฐ ะดะปั ะฐะฒัะพะผะฐัะธะทะฐัะธะธ ะฟัะธะตะผะฐ, ะพะฑัะฐะฑะพัะบะธ ะธ ััะตัะฐ ะทะฐะบะฐะทะพะฒ ะบะพะฝะดะธัะตััะบะพะน ัะตัะตะท WhatsApp ะผะตััะตะฝะดะถะตั. ะกะธััะตะผะฐ ะธัะฟะพะปัะทัะตั ะธัะบััััะฒะตะฝะฝัะน ะธะฝัะตะปะปะตะบั (OpenAI GPT-4 + LangGraph) ะดะปั ัะฐะทะณะพะฒะพัะฝะพะณะพ ะฟัะธะตะผะฐ ะทะฐะบะฐะทะพะฒ ะธ ะพะฑัะฐะฑะพัะบะธ ะธััะพัะธัะตัะบะธั ะดะฐะฝะฝัั, ะฐะฒัะพะผะฐัะธัะตัะบะธ ะณะตะฝะตัะธััะตั ะตะถะตะดะฝะตะฒะฝัะต ะพััะตัั.

## โจ ะัะฝะพะฒะฝัะต ะฒะพะทะผะพะถะฝะพััะธ

### ๐ค AI-ะฐะณะตะฝัั ะดะปั ะพะฑัะฐะฑะพัะบะธ

#### **AI Agent Worker (LangGraph)**
- **ะะฐะทะณะพะฒะพัะฝัะน ะฟัะธะตะผ ะทะฐะบะฐะทะพะฒ** ัะตัะตะท WhatsApp
- ะะพะฝัะตะบััะฝะพะต ะฒะตะดะตะฝะธะต ะดะธะฐะปะพะณะฐ ั ะบะปะธะตะฝัะพะผ
- ะะพัะฐะณะพะฒัะน ัะฑะพั ะธะฝัะพัะผะฐัะธะธ:
  - ๏ฟฝ ะะพะทะธัะธะธ ะทะฐะบะฐะทะฐ (ะฝะฐะทะฒะฐะฝะธะต, ะบะพะปะธัะตััะฒะพ)
  - ๏ฟฝ๐ ะะฐัะฐ ะธ ะฒัะตะผั ะดะพััะฐะฒะบะธ
  - ๏ฟฝ ะะดัะตั ะดะพััะฐะฒะบะธ
  - ๐ณ ะกะฟะพัะพะฑ ะพะฟะปะฐัั
  - ๐ค ะะพะฝัะฐะบัะฝะฐั ะธะฝัะพัะผะฐัะธั
- ะะพะดัะฒะตัะถะดะตะฝะธะต ะทะฐะบะฐะทะฐ ะฟะตัะตะด ัะพััะฐะฝะตะฝะธะตะผ
- Whitelist ะดะปั ัะตััะธัะพะฒะฐะฝะธั

#### **Aggregation Worker (OpenAI)**
- **AI-ะฟะฐััะธะฝะณ** ะธััะพัะธัะตัะบะธั ะทะฐะบะฐะทะพะฒ
- ะะฑัะฐะฑะพัะบะฐ ะฝะตััััะบัััะธัะพะฒะฐะฝะฝัั ัะพะพะฑัะตะฝะธะน
- ะะทะฒะปะตัะตะฝะธะต ะธะฝัะพัะผะฐัะธะธ ะธะท ัะตะบััะฐ
- ะะฒัะพะผะฐัะธัะตัะบะฐั ะบะฐัะตะณะพัะธะทะฐัะธั

### ๐ ะะฒัะพะผะฐัะธัะตัะบะธะต ะพััะตัั
- **ะะถะตะดะฝะตะฒะฝะฐั ัะฐัััะปะบะฐ** ะพััะตัะพะฒ ะฟะพ ัะฐัะฟะธัะฐะฝะธั
- ะัะฐัะธะฒะพ ะพััะพัะผะฐัะธัะพะฒะฐะฝะฝัะต ัะพะพะฑัะตะฝะธั ะฒ WhatsApp
- ะกัะฐัะธััะธะบะฐ ะฟะพ ะพะฟะปะฐัะฐะผ ะธ ะบะพะปะธัะตััะฒั ะทะฐะบะฐะทะพะฒ
- ะกะพััะธัะพะฒะบะฐ ะทะฐะบะฐะทะพะฒ ะฟะพ ะฒัะตะผะตะฝะธ ะดะพััะฐะฒะบะธ
- API endpoints ะดะปั ัััะฝะพะน ะพัะฟัะฐะฒะบะธ

### ๐ ะะธะบัะพัะตัะฒะธัะฝะฐั ะฐััะธัะตะบัััะฐ
- **RabbitMQ** ะดะปั ะฝะฐะดะตะถะฝะพะน ะพัะตัะตะดะธ ัะพะพะฑัะตะฝะธะน
- ะขัะธ ัะฟะตัะธะฐะปะธะทะธัะพะฒะฐะฝะฝัั worker'ะฐ:
  - **Message Worker** - ัะพััะฐะฝะตะฝะธะต ะฒัะตั ัะพะฑััะธะน Green API
  - **AI Agent Worker** - ัะฐะทะณะพะฒะพัะฝัะน ะฟัะธะตะผ ะทะฐะบะฐะทะพะฒ (LangGraph)
  - **Aggregation Worker** - ะพะฑัะฐะฑะพัะบะฐ ะธััะพัะธัะตัะบะธั ะทะฐะบะฐะทะพะฒ (OpenAI)
- ะะฐัััะฐะฑะธััะตะผะฐั ะธ ะพัะบะฐะทะพัััะพะนัะธะฒะฐั ัะธััะตะผะฐ
- Docker ะบะพะฝัะตะนะฝะตัะธะทะฐัะธั

### ๐พ ะะฐะดะตะถะฝะพะต ััะฐะฝะตะฝะธะต
- **PostgreSQL** ะฑะฐะทะฐ ะดะฐะฝะฝัั
- ะะพะปะฝะฐั ะธััะพัะธั ะฒัะตั ัะพะพะฑัะตะฝะธะน ะธ ะทะฐะบะฐะทะพะฒ
- ะขะฐะฑะปะธัั ะดะปั ะบะพะฝะฒะตััะฐัะธะน ะธ AI-ะณะตะฝะตัะธัะพะฒะฐะฝะฝัั ะทะฐะบะฐะทะพะฒ
- ะะธะณัะฐัะธะธ ัะตัะตะท Alembic
- ะะฝะดะตะบัั ะดะปั ะฑััััะพะณะพ ะฟะพะธัะบะฐ

## ๐๏ธ ะััะธัะตะบัััะฐ ัะธััะตะผั

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                     WhatsApp (Green API)                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                             โ
                             โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                     FastAPI API (:8000)                          โ
โ  โข Webhook endpoint /receiveNotification                         โ
โ  โข Message routing (manager vs AI agent vs unknown)              โ
โ  โข API endpoints ะดะปั ะพััะตัะพะฒ                                     โ
โ  โข APScheduler ะดะปั ะฐะฒัะพะผะฐัะธัะตัะบะพะน ะพัะฟัะฐะฒะบะธ                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                             โ
                             โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         RabbitMQ Queues                          โ
โ  โข napoleon_message_queue - ะฒัะต ัะพะฑััะธั Green API                โ
โ  โข ai_agent_interactions - ัะพะพะฑัะตะฝะธั ะดะปั AI ะฐะณะตะฝัะฐ               โ
โ  โข incoming_interactions - ะธััะพัะธัะตัะบะธะต ะทะฐะบะฐะทั                   โ
โ  โข order_processing - ะทะฐะบะฐะทั ะดะปั ะฐะณัะตะณะฐัะธะธ                       โ
โโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโ
       โ                       โ                  โ
       โผ                       โผ                  โผ
โโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโโโ
โ Message Worker  โ  โ AI Agent Worker  โ  โ Aggregation Worker โ
โ                 โ  โ                  โ  โ                    โ
โ โข ะกะพััะฐะฝัะตั ะฒัะต โ  โ โข LangGraph FSM  โ  โ โข OpenAI ะฟะฐััะธะฝะณ  โ
โ   ัะพะฑััะธั ะฒ ะะ  โ  โ โข ะะธะฐะปะพะณ ั       โ  โ โข ะะฑัะฐะฑะพัะบะฐ       โ
โ โข ะัะฑะปะธะบัะตั ะฒ   โ  โ   ะบะปะธะตะฝัะพะผ       โ  โ   ะธััะพัะธัะตัะบะธั    โ
โ   order_proc.   โ  โ โข ะกะฑะพั ะธะฝัะพ ะพ    โ  โ   ะทะฐะบะฐะทะพะฒ         โ
โ   queue         โ  โ   ะทะฐะบะฐะทะต         โ  โ โข ะกะพััะฐะฝะตะฝะธะต ะฒ    โ
โ                 โ  โ โข ะะฐะปะธะดะฐัะธั      โ  โ   ัะฐะฑะปะธัั orders  โ
โ                 โ  โ โข ะะพะดัะฒะตัะถะดะตะฝะธะต  โ  โ                    โ
โโโโโโโโโโฌโโโโโโโโโ  โโโโโโโโโโฌโโโโโโโโโโ  โโโโโโโโโโโโฌโโโโโโโโโโ
         โ                    โ                       โ
         โโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโ
                              โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                      PostgreSQL Database                         โ
โ  โข incoming_message - ะฒัะพะดััะธะต ัะพะพะฑัะตะฝะธั                         โ
โ  โข outgoing_message - ะธััะพะดััะธะต ัะพะพะฑัะตะฝะธั                        โ
โ  โข outgoing_api_message - ัะพะพะฑัะตะฝะธั ัะตัะตะท API                    โ
โ  โข conversations - ะดะธะฐะปะพะณะธ AI ะฐะณะตะฝัะฐ                             โ
โ  โข conversation_messages - ัะพะพะฑัะตะฝะธั ะฒ ะดะธะฐะปะพะณะฐั                  โ
โ  โข ai_generated_orders - ะทะฐะบะฐะทั ะพั AI ะฐะณะตะฝัะฐ                     โ
โ  โข orders - ะพะฑัะฐะฑะพัะฐะฝะฝัะต ะทะฐะบะฐะทั (ะธััะพัะธัะตัะบะธะต)                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                             โ
                             โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ               Daily Report Service + Scheduler                   โ
โ  โข ะะตะฝะตัะฐัะธั ะพััะตัะพะฒ ะทะฐ ะดะตะฝั                                     โ
โ  โข ะะฒัะพะผะฐัะธัะตัะบะฐั ะพัะฟัะฐะฒะบะฐ ะฟะพ ัะฐัะฟะธัะฐะฝะธั (00:30)                 โ
โ  โข ะัะฟัะฐะฒะบะฐ ะฒ WhatsApp ัะฐั ะผะตะฝะตะดะถะตัะฐ                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ๐ ะัััััะน ััะฐัั

### ะัะตะดะฒะฐัะธัะตะปัะฝัะต ััะตะฑะพะฒะฐะฝะธั

- Python 3.10+
- Docker & Docker Compose
- Green API ะฐะบะบะฐัะฝั
- OpenAI API ะบะปัั

### ๐ณ ะะฐะฟััะบ ัะตัะตะท Docker (ัะตะบะพะผะตะฝะดัะตััั)

1. **ะะฐัััะพะนัะต ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั:**
```bash
cp .env.example .env
nano .env  # ะััะตะดะฐะบัะธััะนัะต .env ัะฐะนะป
```

ะะฑัะทะฐัะตะปัะฝัะต ะฟะตัะตะผะตะฝะฝัะต:
```env
GREENAPI_INSTANCE=your_instance
GREENAPI_TOKEN=your_token
OPENAI_API_KEY=your_openai_key
MANAGER_CHAT_IDS=77028639438@c.us
AI_AGENT_CHAT_IDS=77006458263@c.us
```

2. **ะะฐะฟัััะธัะต ะฒัะต ัะตัะฒะธัั:**
```bash
docker compose up -d
```

3. **ะัะธะผะตะฝะธัะต ะผะธะณัะฐัะธะธ:**
```bash
docker compose exec api alembic upgrade head
```

4. **ะัะพะฒะตัััะต ััะฐััั:**
```bash
./health_check.sh
# ะธะปะธ
docker compose ps
```

### ๐ป ะะพะบะฐะปัะฝัะน ะทะฐะฟััะบ (ะดะปั ัะฐะทัะฐะฑะพัะบะธ)

1. **ะฃััะฐะฝะพะฒะธัะต ะทะฐะฒะธัะธะผะพััะธ:**
```bash
pip install -r requirements.txt
```

2. **ะะฐะฟัััะธัะต ะธะฝััะฐััััะบัััั (PostgreSQL + RabbitMQ):**
```bash
docker compose up -d postgres rabbitmq
```

3. **ะัะธะผะตะฝะธัะต ะผะธะณัะฐัะธะธ:**
```bash
alembic upgrade head
```

4. **ะะฐะฟัััะธัะต ัะตัะฒะธัั ะฒ ะพัะดะตะปัะฝัั ัะตัะผะธะฝะฐะปะฐั:**
```bash
# ะขะตัะผะธะฝะฐะป 1: FastAPI
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

# ะขะตัะผะธะฝะฐะป 2: Message Worker
python app/rabbitmq_worker.py

# ะขะตัะผะธะฝะฐะป 3: AI Agent Worker
python app/ai_agent_worker.py

# ะขะตัะผะธะฝะฐะป 4: Aggregation Worker
python app/order_processor_worker.py
```

## ๐ ะะพะฝัะธะณััะฐัะธั

### ะัะฝะพะฒะฝัะต ะฝะฐัััะพะนะบะธ (.env)

```env
# Green API
GREENAPI_INSTANCE=your_instance_id
GREENAPI_TOKEN=your_token
GREEN_API_BASE_URL=https://api.greenapi.com/waInstance

# RabbitMQ
RABBITMQ_HOST=localhost
RABBITMQ_PORT=5672
RABBITMQ_USER=guest
RABBITMQ_PASSWORD=guest
RABBITMQ_QUEUE=napoleon_message_queue
ORDER_PROCESSING_QUEUE=order_processing

# OpenAI
OPENAI_API_KEY=your_openai_key
OPENAI_MODEL=gpt-4o-mini

# PostgreSQL
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres
POSTGRES_DB=napoleon_db
DATABASE_URL=postgresql://postgres:postgres@localhost:5411/napoleon_db

# Chat IDs for routing
MANAGER_CHAT_IDS=77028639438@c.us
AI_AGENT_CHAT_IDS=77006458263@c.us

# Scheduler
SCHEDULER_ENABLED=true
DAILY_REPORT_TIME=00:30
DAILY_REPORT_CHAT_ID=77028639438@c.us
DAILY_REPORT_TIMEZONE=Asia/Almaty
```

### ะะฐัััััะธะทะฐัะธั ัะพะพะฑัะตะฝะธะน

ะกะธััะตะผะฐ ะฐะฒัะพะผะฐัะธัะตัะบะธ ะพะฟัะตะดะตะปัะตั ัะธะฟ ะพะฑัะฐะฑะพัะบะธ ะฝะฐ ะพัะฝะพะฒะต chat_id:

- **MANAGER_CHAT_IDS** - ัะพะพะฑัะตะฝะธั ะพั ะผะตะฝะตะดะถะตัะฐ (ัะพััะฐะฝััััั ะฒ ะะ, ะฝะต ะพะฑัะฐะฑะฐััะฒะฐัััั)
- **AI_AGENT_CHAT_IDS** - ัะพะพะฑัะตะฝะธั ะดะปั AI ะฐะณะตะฝัะฐ (ัะฐะทะณะพะฒะพัะฝัะน ะฟัะธะตะผ ะทะฐะบะฐะทะพะฒ)
- **ะัะพัะธะต** - ะธะณะฝะพัะธัััััั (ะฑะตะทะพะฟะฐัะฝะพััั)

## ๐ API Endpoints

### Webhook
- `POST /receiveNotification` - ะัะธะตะผ ัะฒะตะดะพะผะปะตะฝะธะน ะพั Green API

### ะัะฟัะฐะฒะบะฐ ัะพะพะฑัะตะฝะธะน
- `POST /sendMessage` - ะัะฟัะฐะฒะบะฐ ัะพะพะฑัะตะฝะธั ะฒ WhatsApp
- `DELETE /removeNotification/{receipt_id}` - ะฃะดะฐะปะตะฝะธะต ัะฒะตะดะพะผะปะตะฝะธั

### ะััะตัั
- `GET /orders/daily-report/{date}` - ะัะตะดะฟัะพัะผะพัั ะพััะตัะฐ
- `POST /orders/preview-daily-report` - ะัะตะดะฟัะพัะผะพัั (POST)
- `POST /orders/send-daily-report` - ะัะฟัะฐะฒะธัั ะพััะตั ะฒ WhatsApp

### ะะพะฝะธัะพัะธะฝะณ
- `GET /scheduler/status` - ะกัะฐััั ะฟะปะฐะฝะธัะพะฒัะธะบะฐ

## ๐ฆ ะกัััะบัััะฐ ะฟัะพะตะบัะฐ

```
wapp_sentinel/v2/
โโโ app/
โ   โโโ main.py                    # FastAPI ะฟัะธะปะพะถะตะฝะธะต + routing
โ   โโโ scheduler.py               # APScheduler ะดะปั ะฐะฒัะพะผะฐัะธัะตัะบะธั ะทะฐะดะฐั
โ   โโโ rabbitmq_worker.py         # Message Worker (ัะพััะฐะฝะตะฝะธะต ัะพะฑััะธะน)
โ   โโโ ai_agent_worker.py         # AI Agent Worker (LangGraph ะดะธะฐะปะพะณะธ)
โ   โโโ order_processor_worker.py  # Aggregation Worker (OpenAI ะฟะฐััะธะฝะณ)
โ   โโโ agents/
โ   โ   โโโ state.py               # OrderState TypedDict
โ   โ   โโโ nodes.py               # LangGraph ัะทะปั
โ   โ   โโโ order_graph.py         # LangGraph workflow
โ   โโโ database/
โ   โ   โโโ database.py            # SQLAlchemy setup
โ   โ   โโโ models.py              # ะะพะดะตะปะธ ะะ (+ conversations, ai_orders)
โ   โโโ services/
โ   โ   โโโ openai_service.py      # OpenAI ะธะฝัะตะณัะฐัะธั
โ   โ   โโโ daily_report_service.py # ะะตะฝะตัะฐัะธั ะพััะตัะพะฒ
โ   โโโ processors/
โ       โโโ diagnose.py            # ะฃัะธะปะธัั ะดะธะฐะณะฝะพััะธะบะธ
โ       โโโ process_historical_orders.py # ะะฑัะฐะฑะพัะบะฐ ะธััะพัะธะธ
โโโ migrations/                    # Alembic ะผะธะณัะฐัะธะธ
โโโ Dockerfile.api                 # Docker ะดะปั API
โโโ Dockerfile.message_worker      # Docker ะดะปั Message Worker
โโโ Dockerfile.ai_agent_worker     # Docker ะดะปั AI Agent Worker
โโโ Dockerfile.aggregation_worker  # Docker ะดะปั Aggregation Worker
โโโ docker-compose.yml             # Docker Compose ะบะพะฝัะธะณััะฐัะธั
โโโ docker-compose.prod.yml        # Production overrides
โโโ Makefile                       # ะฃะดะพะฑะฝัะต ะบะพะผะฐะฝะดั
โโโ health_check.sh               # ะกะบัะธะฟั ะฟัะพะฒะตัะบะธ ะทะดะพัะพะฒัั
โโโ requirements.txt               # Python ะทะฐะฒะธัะธะผะพััะธ
โโโ alembic.ini                    # Alembic ะบะพะฝัะธะณััะฐัะธั
โโโ .env                           # ะะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั
โโโ README.md                      # ะญัะพั ัะฐะนะป
```

## ๐ณ Docker Services

### Development (docker-compose.yml)
```yaml
services:
  postgres:            # PostgreSQL ะฑะฐะทะฐ ะดะฐะฝะฝัั (ะฟะพัั 5411)
  rabbitmq:            # RabbitMQ message broker (5672, 15672)
  api:                 # FastAPI application (ะฟะพัั 8000)
  message_worker:      # ะกะพััะฐะฝะตะฝะธะต ะฒัะตั ัะพะฑััะธะน Green API
  ai_agent_worker:     # ะะฐะทะณะพะฒะพัะฝัะน ะฟัะธะตะผ ะทะฐะบะฐะทะพะฒ (LangGraph)
  aggregation_worker:  # ะะฑัะฐะฑะพัะบะฐ ะธััะพัะธัะตัะบะธั ะทะฐะบะฐะทะพะฒ (OpenAI)
```

### ะะพะผะฐะฝะดั ัะฟัะฐะฒะปะตะฝะธั (Makefile)
```bash
make up              # ะะฐะฟัััะธัั ะฒัะต ัะตัะฒะธัั
make down            # ะััะฐะฝะพะฒะธัั ะฒัะต ัะตัะฒะธัั
make logs            # ะกะผะพััะตัั ะฒัะต ะปะพะณะธ
make logs-api        # ะะพะณะธ API
make logs-message    # ะะพะณะธ Message Worker
make logs-ai         # ะะพะณะธ AI Agent Worker
make logs-aggregation # ะะพะณะธ Aggregation Worker
make restart         # ะะตัะตะทะฐะฟัััะธัั ะฒัะต
make migrate         # ะัะธะผะตะฝะธัั ะผะธะณัะฐัะธะธ
make shell           # Bash ะฒ API ะบะพะฝัะตะนะฝะตัะต
make db-shell        # PostgreSQL shell
make ps              # ะกัะฐััั ะบะพะฝัะตะนะฝะตัะพะฒ
```

## ๐ ะะธะทะฝะตะฝะฝัะน ัะธะบะป ะพะฑัะฐะฑะพัะบะธ

### ะะฐัะธะฐะฝั 1: AI Agent (ะฝะพะฒัะต ะทะฐะบะฐะทั)

1. **ะะปะธะตะฝั ะพัะฟัะฐะฒะปัะตั ัะพะพะฑัะตะฝะธะต** ะฒ WhatsApp (ะธะท AI_AGENT_CHAT_IDS)
2. **Green API webhook** โ FastAPI `/receiveNotification`
3. **FastAPI ะผะฐัััััะธะทะฐัะธั** โ ะพะฟัะตะดะตะปัะตั ัะธะฟ = `client`
4. **ะัะฑะปะธะบะฐัะธั** ะฒ `ai_agent_interactions` ะพัะตัะตะดั
5. **AI Agent Worker** (LangGraph):
   - ะะพะปััะฐะตั ัะพะพะฑัะตะฝะธะต ะธะท ะพัะตัะตะดะธ
   - ะะฐะณััะถะฐะตั/ัะพะทะดะฐะตั ัะพััะพัะฝะธะต ะดะธะฐะปะพะณะฐ
   - ะะฑัะฐะฑะฐััะฒะฐะตั ัะตัะตะท ะณัะฐั ัะพััะพัะฝะธะน
   - ะกะพะฑะธัะฐะตั ะธะฝัะพัะผะฐัะธั ะพ ะทะฐะบะฐะทะต ะฟะพัะฐะณะพะฒะพ
   - ะะฐะปะธะดะธััะตั ะธ ะฟะพะดัะฒะตัะถะดะฐะตั
   - ะกะพััะฐะฝัะตั ะฒ `conversations`, `conversation_messages`, `ai_generated_orders`
   - ะัะฟัะฐะฒะปัะตั ะพัะฒะตัั ะฒ WhatsApp ัะตัะตะท Green API

### ะะฐัะธะฐะฝั 2: ะััะพัะธัะตัะบะธะต ะทะฐะบะฐะทั (ะผะตะฝะตะดะถะตั)

1. **ะะตะฝะตะดะถะตั ะพัะฟัะฐะฒะปัะตั ัะพะพะฑัะตะฝะธะต** ะฒ WhatsApp (ะธะท MANAGER_CHAT_IDS)
2. **Green API webhook** โ FastAPI `/receiveNotification`
3. **FastAPI ะผะฐัััััะธะทะฐัะธั** โ ะพะฟัะตะดะตะปัะตั ัะธะฟ = `manager`
4. **ะัะฑะปะธะบะฐัะธั** ะฒ `napoleon_message_queue` ะพัะตัะตะดั
5. **Message Worker**:
   - ะะพะปััะฐะตั ะธะท `napoleon_message_queue`
   - ะกะพััะฐะฝัะตั ะฒัะต ัะพะฑััะธั ะฒ ะะ (incoming_message, outgoing_message, etc.)
   - ะัะฑะปะธะบัะตั ะฒ `order_processing` ะพัะตัะตะดั
6. **Aggregation Worker** (OpenAI):
   - ะะพะปััะฐะตั ะธะท `order_processing` ะพัะตัะตะดะธ
   - ะะฐััะธั ัะตะบัั ั ะฟะพะผะพััั OpenAI GPT-4
   - ะะทะฒะปะตะบะฐะตั ััััะบัััะธัะพะฒะฐะฝะฝัะต ะดะฐะฝะฝัะต
   - ะกะพััะฐะฝัะตั ะฒ ัะฐะฑะปะธัั `orders`

### ะะฐัะธะฐะฝั 3: ะะฒัะพะผะฐัะธัะตัะบะธะต ะพััะตัั

1. **APScheduler** ะทะฐะฟััะบะฐะตั ะทะฐะดะฐัั ะฒ 00:30 (Asia/Almaty)
2. **Daily Report Service**:
   - ะกะพะฑะธัะฐะตั ะทะฐะบะฐะทั ะทะฐ ะฟัะพัะตะดัะธะน ะดะตะฝั
   - ะะตะฝะตัะธััะตั ะบัะฐัะธะฒะพ ะพััะพัะผะฐัะธัะพะฒะฐะฝะฝัะน ะพััะตั
   - ะัะฟัะฐะฒะปัะตั ะฒ WhatsApp ัะฐั ะผะตะฝะตะดะถะตัะฐ
   - ะกัะฐัะธััะธะบะฐ: ะบะพะปะธัะตััะฒะพ ะทะฐะบะฐะทะพะฒ, ะพะฟะปะฐัะตะฝะฝัะต/ะฝะตะพะฟะปะฐัะตะฝะฝัะต

## ๐ ะคะพัะผะฐั ะตะถะตะดะฝะตะฒะฝะพะณะพ ะพััะตัะฐ

```
๐ ะะะะะะซ ะะ 04.11.2025
ะัะตะณะพ ะทะฐะบะฐะทะพะฒ: 3

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
ะะะะะ #1
๐ ะัะตะผั ะดะพััะฐะฒะบะธ: 12:00
๐ณ โ ะะฟะปะฐัะตะฝะพ
๐ค ะะปะธะตะฝั: ะะนะฝัั
๐ฑ ะะพะฝัะฐะบั: +77001234567
๐ฆ ะขะพะฒะฐัั:
   โข ะขะพัั "ะะฐะฟะพะปะตะพะฝ" - 1 ะบะณ
   โข ะะฐะฟะบะตะนะบะธ - 6 ัั
๐ ะัะธะฝัั: 03.11.2025 18:30

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
ะะะะะ #2
๐ ะัะตะผั ะดะพััะฐะฒะบะธ: 14:00
๐ณ โ ะะต ะพะฟะปะฐัะตะฝะพ
๐ค ะะปะธะตะฝั: ะะฐัะธั
๐ฑ ะะพะฝัะฐะบั: +77009876543
๐ฆ ะขะพะฒะฐัั:
   โข ะขะพัั "ะัะฐะณะฐ" - 2 ะบะณ
๐ ะัะธะฝัั: 04.11.2025 09:00

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ะกะขะะขะะกะขะะะ:
   โข ะัะตะณะพ ะทะฐะบะฐะทะพะฒ: 2
   โข ะะฟะปะฐัะตะฝะพ: 1
   โข ะะต ะพะฟะปะฐัะตะฝะพ: 1
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ๐๏ธ ะะฐะทัะฐะฑะพัะบะฐ

### ะกะพะทะดะฐะฝะธะต ะฝะพะฒะพะน ะผะธะณัะฐัะธะธ
```bash
# ะงะตัะตะท Docker
docker compose exec api alembic revision --autogenerate -m "description"
docker compose exec api alembic upgrade head

# ะะพะบะฐะปัะฝะพ
alembic revision --autogenerate -m "description"
alembic upgrade head
```

### ะขะตััะธัะพะฒะฐะฝะธะต
```bash
# ะขะตัั daily report
python test_daily_report.py

# ะัะพะฒะตัะบะฐ AI Agent
# ะัะฟัะฐะฒััะต ัะพะพะฑัะตะฝะธะต ั ะฝะพะผะตัะฐ ะธะท AI_AGENT_CHAT_IDS
```

### ะะพะฝะธัะพัะธะฝะณ
```bash
# Health check ะฒัะตั ัะตัะฒะธัะพะฒ
./health_check.sh

# RabbitMQ Management UI
http://localhost:15672
# Login: guest / Password: guest

# API Documentation
http://localhost:8000/docs

# Scheduler status
curl http://localhost:8000/scheduler/status

# ะะพะณะธ Docker
docker compose logs -f
docker compose logs -f ai_agent_worker
docker compose logs -f message_worker
docker compose logs -f aggregation_worker
```

## ๐ง Troubleshooting

### AI Agent Worker ะฝะต ะพัะฒะตัะฐะตั
```bash
# ะัะพะฒะตัััะต ะปะพะณะธ
docker compose logs -f ai_agent_worker

# ะฃะฑะตะดะธัะตัั ััะพ:
# 1. OPENAI_API_KEY ัััะฐะฝะพะฒะปะตะฝ
# 2. Chat ID ะตััั ะฒ AI_AGENT_CHAT_IDS
# 3. RabbitMQ ะพัะตัะตะดั ai_agent_interactions ัะพะทะดะฐะฝะฐ
# 4. Worker ะทะฐะฟััะตะฝ ะธ ะฟะพะดะบะปััะตะฝ ะบ RabbitMQ

# ะัะพะฒะตัััะต ะพัะตัะตะดั
docker compose exec rabbitmq rabbitmqctl list_queues
```

### Message Worker ะฝะต ัะพััะฐะฝัะตั ัะพะฑััะธั
```bash
# ะัะพะฒะตัััะต ะปะพะณะธ
docker compose logs -f message_worker

# ะัะพะฒะตัััะต ะฟะพะดะบะปััะตะฝะธะต ะบ ะะ
docker compose exec message_worker python -c "from app.database.database import engine; engine.connect()"

# ะัะพะฒะตัััะต RabbitMQ
docker compose exec rabbitmq rabbitmq-diagnostics ping
```

### Aggregation Worker ะฝะต ะพะฑัะฐะฑะฐััะฒะฐะตั ะทะฐะบะฐะทั
```bash
# ะัะพะฒะตัััะต ะปะพะณะธ
docker compose logs -f aggregation_worker

# ะัะพะฒะตัััะต OpenAI API ะบะปัั
docker compose exec aggregation_worker python -c "import os; print(os.getenv('OPENAI_API_KEY'))"

# ะัะพะฒะตัััะต ะพัะตัะตะดั
docker compose exec rabbitmq rabbitmqctl list_queues | grep order_processing
```

### RabbitMQ ะฟะพะดะบะปััะตะฝะธะต
```bash
# ะัะพะฒะตัััะต ััะพ credentials ัะพะฒะฟะฐะดะฐัั ะฒ .env ะธ docker-compose.yml
# ะัะพะฒะตัััะต ะดะพัััะฟะฝะพััั
docker compose exec api ping -c 3 rabbitmq
```

### PostgreSQL ะฟะพะดะบะปััะตะฝะธะต
```bash
# ะัะพะฒะตัััะต ััะฐััั
docker compose exec postgres pg_isready

# ะัะพะฒะตัััะต ะฟะพัั (5411 ะฒะผะตััะพ 5432)
DATABASE_URL=postgresql://postgres:postgres@localhost:5411/napoleon_db

# ะะพะดะบะปััะธัะตัั ะบ ะะ
docker compose exec postgres psql -U postgres -d napoleon_db
```

### Scheduler ะฝะต ะพัะฟัะฐะฒะปัะตั ะพััะตัั
```bash
# ะัะพะฒะตัััะต ะฝะฐัััะพะนะบะธ ะฒ .env
SCHEDULER_ENABLED=true
DAILY_REPORT_TIME=00:30
DAILY_REPORT_CHAT_ID=77028639438@c.us
DAILY_REPORT_TIMEZONE=Asia/Almaty

# ะัะพะฒะตัััะต ััะฐััั
curl http://localhost:8000/scheduler/status

# ะััะฝะฐั ะพัะฟัะฐะฒะบะฐ ะดะปั ัะตััะฐ
curl -X POST http://localhost:8000/orders/send-daily-report
```

## ๐ ะขะตัะฝะพะปะพะณะธะธ

### Backend
- **FastAPI** - ัะพะฒัะตะผะตะฝะฝัะน ะฒะตะฑ-ััะตะนะผะฒะพัะบ
- **SQLAlchemy** - ORM ะดะปั ัะฐะฑะพัั ั ะะ
- **Alembic** - ะผะธะณัะฐัะธะธ ะฑะฐะทั ะดะฐะฝะฝัั
- **Pika** - Python ะบะปะธะตะฝั ะดะปั RabbitMQ
- **APScheduler** - ะฟะปะฐะฝะธัะพะฒัะธะบ ะทะฐะดะฐั

### AI & ML
- **OpenAI GPT-4o-mini** - ะฟะฐััะธะฝะณ ะธััะพัะธัะตัะบะธั ะทะฐะบะฐะทะพะฒ
- **LangGraph** - ะณัะฐั ัะพััะพัะฝะธะน ะดะปั AI ะฐะณะตะฝัะฐ
- **LangChain** - ะธะฝัะตะณัะฐัะธั ั LLM

### Infrastructure
- **PostgreSQL 15** - ัะตะปััะธะพะฝะฝะฐั ะะ
- **RabbitMQ 3** - ะพัะตัะตะดะธ ัะพะพะฑัะตะฝะธะน
- **Docker & Docker Compose** - ะบะพะฝัะตะนะฝะตัะธะทะฐัะธั
- **Green API** - WhatsApp ะธะฝัะตะณัะฐัะธั

## ๐ค ะฃัะฐััะธะต ะฒ ัะฐะทัะฐะฑะพัะบะต

ะัะพะตะบั ัะฐะทัะฐะฑะพัะฐะฝ ะดะปั ะฐะฒัะพะผะฐัะธะทะฐัะธะธ ัะฐะฑะพัั ะบะพะฝะดะธัะตััะบะพะน Napoleon Tseh.

## ๐ ะะธัะตะฝะทะธั

Proprietary - ะฒัะต ะฟัะฐะฒะฐ ะทะฐัะธัะตะฝั

## ๐จโ๐ป ะะฒัะพั

**Napoleon Tseh Team**
- Repository: beybars1/napoleon_tseh
- Branch: main

## ๐ ะกะฒัะทะฐะฝะฝัะต ะฟัะพะตะบัั

- Green API - https://green-api.com
- OpenAI API - https://openai.com
- APScheduler - https://apscheduler.readthedocs.io

---

**ะะตััะธั:** 2.0  
**ะะพัะปะตะดะฝะตะต ะพะฑะฝะพะฒะปะตะฝะธะต:** ะะพัะฑัั 2025
